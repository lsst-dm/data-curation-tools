# Scripts to Update DID Metadata

## Introduction
Rucio's REST API has some protections on certain DID metadata, in our case, filesize (`bytes`), `md5`, and `adler32`. This directory contains scripts to gather DID metadata from Rucio and from using gfal as well as update the metadata.

`gather_metadata.py` fetches DID metadata from Rucio, including PFNs from the specific `RAW_DISK` RSE. After collecting the Rucio metadata, the script fetches updated metadata using `gfal2`. `gfal2` uses the PFNs to get the file sizes, and md5 and adler32 checksums. This metadata is then saved to a JSON file. This script requires `rucio-clients` and `python-gfal2` clients.

`update_did_metadata.py` updates DIDs based on the collected metadata from the `gather_metadata.py` script. This script relies on the Rucio internal core API. Thus, it requires database access. This is best run in a running pod.

`check_did_status.py` checks and optionally boosts rules related to the DIDs.

## Usage
```
usage: gather_metadata.py [-h] dids_file corrections_file

A utility that fetches DID metadata from a list of DIDs and saves updated metadata corrections.

positional arguments:
  dids_file         File containing the list of DIDs on each line
  corrections_file  File path to save the generated corrections

options:
  -h, --help        show this help message and exit

```

```
usage: update_did_metadata.py [-h] corrections_file

Updates DID metadata from a corrections file

positional arguments:
  corrections_file  JSON file with DID corrections

optional arguments:
  -h, --help        show this help message and exit
```

```
usage: check_did_status.py [-h] [--boost] dids_file

Checks the status of a given list of DIDs

positional arguments:
  dids_file   File with list of DIDs

options:
  -h, --help  show this help message and exit
  --boost     Boost the rules. Default False.
```

## Updating DID metadata
To update the metadata, copy the corrections file generated by `gather_metadata.py` and copy the `update_did_metadata.py` script to the `rucio-server` container on a running `rucio-server` pod. The Rucio server pods contains the core `rucio` package as well as database connection information.
```bash
# Fetch rucio-server pods
kubectl -n <namespace> get pods | grep rucio-server

# Copy files to the rucio-server container in the pods
kubectl -n <namespace> -c rucio-server cp <corrections_file>.json <rucio-server-pod-name>:/tmp/<corrections_file>.json
kubectl -n <namespace> -c rucio-server cp update_did_metadata.py <rucio-server-pod-name>:/tmp/update_did_metadata.py
```

Enter the pod interactively and run the script
```bash
kubectl exec -it -n <namespace-name> <rucio-server-pod-name> -c rucio-server -- bash

## inside the pod
python3 /tmp/update_did_metadata.py /tmp/<corrections_file>.json
```

Delete scripts manually or by deleting and restarting the pod.


## Caveats
Rucio developers do not recommend directly using the core API to do such operations. Best practice would be to not modify the file after the file has been registered into Rucio. Use these scripts sparingly.
